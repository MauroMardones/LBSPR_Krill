---
title: "Supporting Information 3"
subtitle: "Disparate estimates of intrinsic productivity for Antarctic krill (Euphausia superba) across small spatial scales, under a rapidly changing ocean."
author: "Mardones, M; Jarvis Mason, E.T.;  Santa Cruz, F.; Watters, G.; Cárdenas, C.A"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: LBSPR.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
output:
  bookdown::pdf_document2:
    fig_caption: yes
    keep_md: true
    toc: true
    toc_deep: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
    theme: cosmo
    fontsize: 0.9em
    linestretch: 1.7
    html-math-method: katex
    self-contained: true
    code-tools: true
    number_sections: false
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
# Cargar paquetes necesarios
library(LBSPR)
library(dplyr)
library(ggplot2)
library(egg)
```
# Methodological Approach: Operating Model Construction  

To evaluate the performance of the Length-Based Spawning Potential Ratio (LBSPR) model in estimating fishing mortality (*F*) and Spawning Potential Ratio (*SPR*) in krill (*Euphausia superba*), we developed an Operating Model (OM) that simulates population dynamics under different fishing pressures. The OM provides a controlled environment to generate synthetic length-frequency data, allowing us to assess the accuracy and bias of LBSPR estimates.  



### Population Dynamics Simulation  
The population was modeled using a size-structured framework based on the von Bertalanffy growth function (VBGF):  

\[
L_t = L_{\infty} \left(1 - e^{-k(t - t_0)}\right)
\]

where:  
- \( L_t \) is the length at age \( t \),  
- \( L_{\infty} \) is the asymptotic maximum length,  
- \( k \) is the growth coefficient,  
- \( t_0 \) is the theoretical age at length zero.  

Natural mortality (\( M \)) was assumed constant and taken from the literature. Recruitment followed a Beverton-Holt stock-recruitment relationship, and selectivity was modeled as a logistic function.  

### Fishing Scenarios  
We simulated multiple fishing mortality scenarios (\( F \)) to assess the robustness of LBSPR estimates:  
- Low exploitation: \( F = 0.2 \)  
- Moderate exploitation: \( F = 0.5 \)  
- High exploitation: \( F = 1.0 \)  
- Overexploitation: \( F = 1.5 \)  

For each scenario, a length-based catch-at-size distribution was generated using a deterministic fishing process combined with stochastic recruitment.  

### Generation of Length-Frequency Data  


The OM generated synthetic length-frequency data by sampling individuals from the simulated population at different time steps. The sampling process mimicked empirical fisheries-dependent and fisheries-independent data collection.   

We applied sampling variability to reflect realistic observation errors and deviations due to gear selectivity.  

### Estimation Procedure Using LBSPR  

The synthetic length data were analyzed using the LBSPR framework (R package *LBSPR*). The model estimated:  
1. Fishing mortality (*F*)  
2. Spawning Potential Ratio (*SPR*)  

The estimated values were compared against true values from the OM to assess bias and accuracy.  

### Performance Evaluation Metrics  

To quantify the performance of LBSPR, we used:  
- Bias: \( Bias = \frac{F_{est} - F_{true}}{F_{true}} \)  
- Mean Absolute Error (MAE): \( MAE = \frac{1}{n} \sum |F_{est} - F_{true}| \)  
- Root Mean Squared Error (RMSE): \( RMSE = \sqrt{\frac{1}{n} \sum (F_{est} - F_{true})^2} \)  

Additionally, we plotted estimated vs. true values to visualize systematic deviations in LBSPR estimates.  

### Interpretation of Results  
- If estimates align with true values, LBSPR is accurate and unbiased.  
- If estimates consistently overestimate or underestimate \( F \) and \( SPR \), LBSPR exhibits systematic bias.  
- Performance under different exploitation levels highlights the robustness of LBSPR in krill stock assessments.  


## MO 

```{r message=FALSE, warning=FALSE}
# Definir Parámetros del Krill
set.seed(123)
Linf <- 60     # Longitud asintótica (mm)
k <- 0.4       # Coeficiente de crecimiento
t0 <- -0.5     # Edad a L=0
M <- 0.4       # Mortalidad natural
F_scenarios <- seq(0,1.6,0.2)  # Diferentes niveles de explotación
years <- 30    # Simular 30 años

#  Función para Simular Población
simulate_population <- function(F, years) {
  ages <- sample(seq(0, 8, by = 0.1), size = 5000, replace = TRUE)  # Distribución de edades
  lengths <- Linf * (1 - exp(-k * (ages - t0)))  # Crecimiento
  survival <- exp(- (M + F) * ages)  # Mortalidad natural + pesca
  
  # Generar estructura de tallas final
  krill_pop <- data.frame(Age = ages, Length = lengths, Survival = survival) %>%
    filter(runif(n()) < Survival)  # Muestreo de supervivientes
  
  return(krill_pop)
}

#  Aplicar Modelo LBSPR y Evaluar Sesgo
evaluate_LBSPR <- function(F) {
  krill_data <- simulate_population(F, years)  # Simula población
  
  # Simular muestreo de captura
  sampled_data <- krill_data %>% sample_n(300)
  
  # Configurar parámetros del modelo LBSPR
  LB_obj <- new("LB_pars")
  LB_obj@Linf <- Linf
  LB_obj@MK <- M / k  
  LB_obj@L50 <- 35  # Longitud media de madurez
  LB_obj@L95 <- 50  # Longitud al 95% de madurez
  
  # Crear objeto de longitudes
  LB_data <- new("LB_lengths")
  LB_data@LMids <- seq(0, Linf, by = 2)
  
  # Crear histograma de longitudes
  hist_data <- hist(sampled_data$Length, breaks = LB_data@LMids, plot = FALSE)$counts
  LB_data@LData <- matrix(hist_data, ncol = 1)
  
  #  Solución del error de "Years must be numeric"
  LB_data@Years <- 1  # Definir número de años
  LB_data@NYears <- 1
  
  # Ajustar modelo LBSPR
  LB_fit <- LBSPRfit(LB_obj, LB_data)
  
  # Guardar resultados
  return(data.frame(F_real = F, 
                    F_est = LB_fit@FM, 
                    SPR_real = exp(-F), 
                    SPR_est = LB_fit@SPR))
}



#  Evaluar Sesgo en Distintos Escenarios
results <- lapply(F_scenarios, evaluate_LBSPR) %>% bind_rows()
```


```{r}
# ⃣ Visualizar Resultados
Fses <- ggplot(results, aes(x = F_real, y = F_est)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(x = "F Real", y = "F Estimado (LBSPR)", title = "") +
  theme_minimal()

sprses <- ggplot(results, aes(x = SPR_real, y = SPR_est)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(x = "SPR Real", y = "SPR Estimado (LBSPR)", title = "") +
  theme_minimal()

ggarrange(Fses,
          sprses,
          ncol=2)
```
Here is the full translation into clear, professional scientific English:

---

**What does the plot represent?**

* **X-axis (True F):** The true fishing mortality values used in the simulation.
* **Y-axis (Estimated F – LBSPR):** Fishing mortality values estimated by the LBSPR model.
* **Dashed line:** Represents the ideal relationship, *Estimated F = True F*, meaning an unbiased estimation.

**How should the relationship between the points and the line be interpreted?**

* If points lie **on the line**, LBSPR is estimating *F* accurately.
* If points lie **below the line**, LBSPR **underestimates** *F*.
* If points lie **above the line**, LBSPR **overestimates** *F*.

**What is observed in this plot?**

* For low F values (~0–0.5), LBSPR appears to estimate F correctly or with slight overestimation.
* For moderate and high F values (>0.5), LBSPR strongly **overestimates** F.

  * For *True F = 1.0*, LBSPR estimates approximately 3.0.
  * For *True F = 1.5*, LBSPR estimates nearly 4.0.

**Possible causes of bias in the estimation of F**
This increasing bias suggests that LBSPR overestimates fishing mortality when exploitation rates are high. Several potential reasons include:

1. **Misspecified growth and longevity parameters**

   * If the simulated population grows faster or lives longer than assumed in LBSPR, the model may interpret this as higher fishing mortality.

2. **Bias in the length-frequency sample**

   * If samples overrepresent small individuals, LBSPR may infer higher mortality because fewer large animals are observed.

3. **LBSPR limitations under high exploitation**

   * LBSPR is designed for equilibrium conditions. Under extreme overfishing, the equilibrium assumption may break down, leading the model to inflate F estimates.



### **Conclusion and recommendations**

* LBSPR performs well at low F levels but overestimates F under high exploitation.
* Potential solutions include:

  * Adjusting sample length composition to test whether bias decreases.
  * Exploring sensitivity to *L∞*, *k*, and *M* in the simulation.
  * Using alternative methods (e.g., age-structured or cohort-based models) to estimate F under heavy fishing pressure.


Here is a clear, rigorous **scientific interpretation in English** of the two operating-model plots for krill LBSPR performance:

---

### **Interpretation of Operating Model Results for LBSPR Applied to Antarctic Krill**

The operating model evaluation reveals systematic deviations between the true values of fishing mortality (F) and SPR and those estimated by the LBSPR model. In the left panel, LBSPR performs reasonably well at very low levels of fishing mortality (F < 0.3), with estimated values lying close to the 1:1 reference line. However, as fishing pressure increases, the model progressively overestimates F. For moderate exploitation (F ~ 0.5–0.8), LBSPR estimates are already two to three times higher than the true values, and under high exploitation (F ≥ 1.0), the overestimation becomes substantial, with predicted F values reaching three to four times the actual rate. This pattern indicates that LBSPR becomes increasingly biased under intensified fishing, consistent with previous findings that equilibrium-based length models can misinterpret truncated size structures as strong fishing mortality.

A similar pattern is observed for SPR in the right panel. For true SPR values below 0.4—which represent depleted population states—LBSPR estimates collapse toward zero, substantially underestimating the true reproductive potential. For intermediate SPR values (0.4–0.6), the model still underestimates SPR, whereas near-virgin conditions (SPR ≈ 1.0) are estimated more accurately. This behavior reflects the difficulty of recovering reliable reproductive metrics from heavily truncated length distributions, a limitation previously reported in LBSPR performance studies.

Taken together, these results demonstrate that LBSPR provides reliable estimates only under light exploitation and becomes increasingly biased as fishing mortality rises and size structures become more truncated. This emphasizes the need for caution when applying LBSPR to krill populations subjected to high exploitation levels or when length-frequency data are limited or unrepresentative.


Ahora con L inf

```{r}

library(purrr)

#  Definir Parámetros del Krill con variabilidad en Linf
set.seed(123)
Linf_values <- c(50, 60, 70)  # Probar diferentes longitudes asintóticas (mm)
k <- 0.4       # Coeficiente de crecimiento
t0 <- -0.5     # Edad a L=0
M <- 0.4       # Mortalidad natural
F_scenarios <- seq(0, 1.5, 0.5)  # Diferentes niveles de explotación
years <- 30    # Simular 30 años

#  Función para Simular Población con variabilidad en Linf
simulate_population <- function(F, years, Linf) {
  ages <- sample(seq(0, 8, by = 0.1), size = 5000, replace = TRUE)  # Distribución de edades
  lengths <- Linf * (1 - exp(-k * (ages - t0)))  # Crecimiento
  survival <- exp(- (M + F) * ages)  # Mortalidad natural + pesca
  
  # Generar estructura de tallas final
  krill_pop <- data.frame(Age = ages, Length = lengths, Survival = survival) %>%
    filter(runif(n()) < Survival)  # Muestreo de supervivientes
  
  return(krill_pop)
}

#  Aplicar Modelo LBSPR y Evaluar Sesgo con variabilidad en Linf
evaluate_LBSPR <- function(F, Linf) {
  krill_data <- simulate_population(F, years, Linf)  # Simula población
  
  # Simular muestreo de captura
  sampled_data <- krill_data %>% sample_n(300)
  
  # Configurar parámetros del modelo LBSPR
  LB_obj <- new("LB_pars")
  LB_obj@Linf <- Linf
  LB_obj@MK <- M / k  
  LB_obj@L50 <- 35  # Longitud media de madurez
  LB_obj@L95 <- 50  # Longitud al 95% de madurez
  
  # Crear objeto de longitudes
  LB_data <- new("LB_lengths")
  LB_data@LMids <- seq(0, Linf, by = 2)
  
  # Crear histograma de longitudes
  hist_data <- hist(sampled_data$Length, breaks = LB_data@LMids, plot = FALSE)$counts
  LB_data@LData <- matrix(hist_data, ncol = 1)
  
  # Solución del error de "Years must be numeric"
  LB_data@Years <- 1  # Definir número de años
  LB_data@NYears <- 1
  
  # Ajustar modelo LBSPR
  LB_fit <- LBSPRfit(LB_obj, LB_data)
  
  # Guardar resultados
  return(data.frame(F_real = F, F_est = LB_fit@FM, SPR_real = exp(-F), SPR_est = LB_fit@SPR, Linf = Linf))
}

# Evaluar Sesgo en Distintos Escenarios y Linf
results <- expand.grid(F = F_scenarios, Linf = Linf_values) %>%
  pmap_dfr(~ evaluate_LBSPR(..1, ..2))  # Ejecutar simulaciones para cada combinación de F y Linf

# Gráficos

# Gráfico de F_est vs F_real para cada Linf
ggplot(results, aes(x = F_real, y = F_est, color = as.factor(Linf))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  labs(title = "Comparación de F_est vs F_real",
       x = "F Real", y = "F Estimado", color = "Linf") +
  theme_minimal()

# Gráfico de SPR_est vs SPR_real para cada Linf
ggplot(results, aes(x = SPR_real, y = SPR_est, color = as.factor(Linf))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "black") +
  labs(title = "Comparación de SPR_est vs SPR_real",
       x = "SPR Real", y = "SPR Estimado", color = "Linf") +
  theme_minimal()

# Gráfico de SPR estimado para cada escenario de explotación y Linf
ggplot(results, aes(x = F_real, y = SPR_est, color = as.factor(Linf))) +
  geom_line() +
  geom_point() +
  labs(title = "SPR Estimado en diferentes escenarios de explotación",
       x = "F Real (Explotación)", y = "SPR Estimado", color = "Linf") +
  theme_minimal()

```


Aquí tienes **el código exacto en R** para calcular **MAE y RMSE** para *F* y para *SPR*, usando tu objeto `results` del Modelo Operativo, y también para **graficarlos** (ambos indicadores por escenario de F).
Puedes pegar directamente este chunk debajo de tu código actual.

---

# ✅ **1. Calcular MAE y RMSE por nivel de F**

```{r}
# Calcular MAE y RMSE por escenario de F
metrics <- results %>%
  mutate(
    error_F   = F_est  - F_real,
    error_SPR = SPR_est - SPR_real
  ) %>%
  group_by(F_real) %>%
  summarise(
    MAE_F   = mean(abs(error_F)),
    RMSE_F  = sqrt(mean(error_F^2)),
    MAE_SPR = mean(abs(error_SPR)),
    RMSE_SPR = sqrt(mean(error_SPR^2))
  )
metrics
```

---

# ✅ **2. Gráfico del MAE**

```{r}
library(ggplot2)
library(ggpubr)

p_mae_F <- ggplot(metrics, aes(x = F_real, y = MAE_F)) +
  geom_line() +
  geom_point() +
  labs(x = "Real F", y = "MAE (F)", title = "Mean Absolute Error for F") +
  theme_minimal()

p_mae_SPR <- ggplot(metrics, aes(x = F_real, y = MAE_SPR)) +
  geom_line() +
  geom_point() +
  labs(x = "Real F", y = "MAE (SPR)", title = "Mean Absolute Error for SPR") +
  theme_minimal()
```

---

# ✅ **3. Gráfico del RMSE**

```{r}
p_rmse_F <- ggplot(metrics, aes(x = F_real, y = RMSE_F)) +
  geom_line() +
  geom_point() +
  labs(x = "Real F", y = "RMSE (F)", title = "RMSE for F") +
  theme_minimal()

p_rmse_SPR <- ggplot(metrics, aes(x = F_real, y = RMSE_SPR)) +
  geom_line() +
  geom_point() +
  labs(x = "Real F", y = "RMSE (SPR)", title = "RMSE for SPR") +
  theme_minimal()
```

---

# ✅ **4. Mostrar todas las figuras juntas**

```{r}
ggarrange(
  p_mae_F, p_mae_SPR,
  p_rmse_F, p_rmse_SPR,
  ncol = 2, nrow = 2
)
```
Aquí tienes una interpretación científica clara y rigurosa en español de los dos gráficos del modelo operativo para el desempeño de LBSPR en krill:

## **1. Errores en la estimación de F (MAE y RMSE)**

Los paneles superiores muestran cómo el error absoluto medio (MAE) y el error cuadrático medio (RMSE) aumentan a medida que la mortalidad por pesca real (*F*) se incrementa.

### **¿Qué significa esto?**

* Cuando **F es bajo (0–0.2)**, LBSPR estima F con poca desviación, mostrando errores muy pequeños.
* A **F moderado (0.5)**, el error aumenta notablemente, indicando que LBSPR comienza a **perder precisión**.
* Con **F alto o sobreexplotación (1.0–1.5)**, tanto MAE como RMSE se elevan de forma casi lineal, reflejando que LBSPR **sobrestima fuertemente la mortalidad por pesca** en condiciones de alta explotación.

### **Interpretación biológica**

El incremento del error sugiere que LBSPR **no es robusto cuando la estructura de tallas está muy truncada por la pesca**, lo cual coincide con lo observado en tus estimaciones directas (puntos alejados de la línea 1:1).


## **2. Errores en la estimación de SPR (MAE y RMSE)**

En los paneles inferiores, los errores de SPR muestran un patrón diferente:

### **¿Qué significa esto?**

* A F muy bajo, los errores de SPR son pequeños, lo que indica que LBSPR captura razonablemente el estado reproductivo cuando la población está poco explotada.
* El error aumenta drásticamente en **F = 0.5**, donde SPR se subestima fuertemente en tu modelo.
* Sin embargo, en **altos F (1.0–1.5)**, tanto MAE como RMSE disminuyen, porque LBSPR tiende a **colapsar las estimaciones de SPR hacia valores cercanos a cero**, independientemente del SPR real.

### **Interpretación biológica**

Este patrón refleja un comportamiento conocido del modelo:

* LBSPR **subestima fuertemente** el SPR cuando la explotación es moderada.
* A altas explotaciones, LBSPR tiende a **igualar todas las estimaciones a SPR ≈ 0**, lo que reduce artificialmente la variabilidad del error.



# **Conclusión general**

* **F:** El error aumenta de forma casi monotónica con el nivel de explotación → LBSPR no es fiable para estimar *F* cuando la pesca es intensa.
* **SPR:** Los errores son máximos en niveles moderados de pesca y decrecen artificialmente en altos niveles de explotación porque LBSPR sistemáticamente colapsa hacia SPR ≈ 0.
* El conjunto de resultados confirma que LBSPR **solo es confiable bajo condiciones de baja explotación** y que presenta **sesgos severos** cuando las poblaciones están truncadas o no cumplen el supuesto de equilibrio.


Aquí tienes un **párrafo sólido, claro y publicable** para la sección **Discusión**, integrando los resultados del Modelo Operativo (OM) con la evidencia previa de la literatura, incluyendo **Hordyk**, **Canales**, **Cousido** y otros estudios sobre desempeño del LBSPR:



### **Draft para sección de Discusión**

Our operating model analysis revealed that LBSPR provides accurate estimates of fishing mortality and SPR only under low exploitation levels, but its performance deteriorates substantially as fishing pressure increases. Both MAE and RMSE for *F* rose almost monotonically with increasing true *F*, reflecting a strong tendency of LBSPR to overestimate fishing mortality when size structures become truncated. Likewise, SPR estimates were strongly downward biased at moderate exploitation levels and collapsed toward zero under high *F*, a pattern consistent with the behavior observed in our estimated-versus-true comparisons. These findings align with previous evaluations showing that LBSPR can produce systematic biases when equilibrium assumptions are violated or when the length distribution lacks larger individuals. In particular, Hordyk et al. (2015) demonstrated that LBSPR underestimates SPR and overestimates *F* when populations are heavily exploited or when growth and selectivity parameters are misspecified. Similar biases have been documented for crustaceans and short-lived invertebrates by Canales and Arcos (2020) and for other small pelagic species by Cousido et al. (2022). Together, our results and previous evidence suggest that LBSPR should be applied with caution in krill assessments, especially in areas with truncated size compositions or limited temporal data, as these conditions can amplify structural biases and hinder reliable estimation of reproductive potential.

